<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Example HBC30 · Geant4.jl</title><meta name="title" content="Example HBC30 · Geant4.jl"/><meta property="og:title" content="Example HBC30 · Geant4.jl"/><meta property="twitter:title" content="Example HBC30 · Geant4.jl"/><meta name="description" content="Documentation for Geant4.jl."/><meta property="og:description" content="Documentation for Geant4.jl."/><meta property="twitter:description" content="Documentation for Geant4.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Geant4.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Geant4.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><a class="tocitem" href="../../api/">Public API</a></li><li><span class="tocitem">Examples</span><ul><li class="is-active"><a class="tocitem" href>Example HBC30</a><ul class="internal"><li><a class="tocitem" href="#Define-the-detector-chamber"><span>Define the detector chamber</span></a></li><li><a class="tocitem" href="#Define-the-simulation-data"><span>Define the simulation data</span></a></li><li><a class="tocitem" href="#Define-the-needed-user-actions"><span>Define the needed user actions</span></a></li><li><a class="tocitem" href="#Define-the-primary-particle-generator,-the-magnetic-filed-and-the-application"><span>Define the primary particle generator, the magnetic filed and the application</span></a></li><li><a class="tocitem" href="#Draw-and-trigger-functions"><span>Draw and trigger functions</span></a></li></ul></li><li><a class="tocitem" href="../WaterPhantom/">Example WaterPhantom</a></li><li><a class="tocitem" href="../B1/">Example B1</a></li><li><a class="tocitem" href="../B2a/">Example B2a</a></li><li><a class="tocitem" href="../B3a/">Example B3a</a></li><li><a class="tocitem" href="../GPS/">Example GPS</a></li><li><a class="tocitem" href="../Solids/">Example Solids</a></li><li><a class="tocitem" href="../TestEm3/">Example TestEm3</a></li></ul></li><li><a class="tocitem" href="../../releases/">Release Notes</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Example HBC30</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Example HBC30</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaHEP/Geant4.jl/blob/master/docs/src/notebooks/HBC30.md#L" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="CERN-Liquid-Hydrogen-Bubble-Chamber"><a class="docs-heading-anchor" href="#CERN-Liquid-Hydrogen-Bubble-Chamber">CERN Liquid Hydrogen Bubble Chamber</a><a id="CERN-Liquid-Hydrogen-Bubble-Chamber-1"></a><a class="docs-heading-anchor-permalink" href="#CERN-Liquid-Hydrogen-Bubble-Chamber" title="Permalink"></a></h1><p>Example to simulate the CERN 30cm bubble chamber fill with liquid hydrogen and using a pion beam of 330 MeV from PS. The original device was like this:</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/30_cm_bubble_chamber.jpg/447px-30_cm_bubble_chamber.jpg" alt/></p><pre><code class="language-julia hljs">using Geant4
using Geant4.SystemOfUnits
using Printf, GeometryBasics
using CairoMakie, Rotations, IGLWrap_jll  # to force loading G4Vis extension</code></pre><h2 id="Define-the-detector-chamber"><a class="docs-heading-anchor" href="#Define-the-detector-chamber">Define the detector chamber</a><a id="Define-the-detector-chamber-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-detector-chamber" title="Permalink"></a></h2><pre><code class="language-julia hljs">include(&quot;DetectorHBC30.jl&quot;)
hbc30 = HBC30()</code></pre><pre><code class="nohighlight hljs">HBC30(300.0, 50.0, false, 192.50000000000003)</code></pre><h2 id="Define-the-simulation-data"><a class="docs-heading-anchor" href="#Define-the-simulation-data">Define the simulation data</a><a id="Define-the-simulation-data-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-simulation-data" title="Permalink"></a></h2><p>The data structure <code>HBC30SimData</code> will be filled by the user actions at the correct moment during the simulation. We collect the points for each track at the step bounderies together with the initial kinetic energy and particle name and charge.</p><pre><code class="language-julia hljs">#---Define Simulation Data struct------------------------------------------------------------------
struct Track
    particle::String
    charge::Int
    energy::Float64
    points::Vector{Point3{Float64}}
end
mutable struct HBC30SimData &lt;: G4JLSimulationData
    #---Run data-----------------------------------------------------------------------------------
    fParticle::String
    fEkin::Float64
    #---trigger/veto-------------------------------------------------------------------------------
    veto::Bool
    #---tracks-------------------------------------------------------------------------------------
    tracks::Vector{Track}
    HBC30SimData() = new(&quot;&quot;, 0.0, false, [])
end
</code></pre><h2 id="Define-the-needed-user-actions"><a class="docs-heading-anchor" href="#Define-the-needed-user-actions">Define the needed user actions</a><a id="Define-the-needed-user-actions-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-needed-user-actions" title="Permalink"></a></h2><ul><li><strong>beginrun</strong> stores the particle type and initial kinetic energy of the generated primary particle</li><li><strong>beginevent</strong> clear the trigger <code>veto</code> and the list of tracks for the current event</li><li><strong>pretrackaction</strong> pushes a new <code>Track</code> with the particle name, charge, intial energy and initial point</li><li><strong>posttackactkion</strong> is used exclusevily to set the <code>veto</code> if the initial particle exists the world without a sizeable interaction</li><li><strong>stepaction</strong> pushes points to the latest <code>Track</code> in the track list</li></ul><pre><code class="language-julia hljs">#---Step action------------------------------------------------------------------------------------
function stepaction(step::G4Step, app::G4JLApplication)::Nothing
    tracks = getSIMdata(app).tracks
    p = step |&gt; GetPostStepPoint |&gt; GetPosition
    auxpoints = step |&gt; GetPointerToVectorOfAuxiliaryPoints
    if auxpoints != C_NULL
        for ap in auxpoints
            push!(tracks[end].points, Point3{Float64}(x(ap),y(ap),z(ap)))
        end
    end
    push!(tracks[end].points, Point3{Float64}(x(p),y(p),z(p)))
    return
end
#---Tracking pre-action---------------------------------------------------------------------------- 
function pretrackaction(track::G4Track, app::G4JLApplication)::Nothing
    tracks = getSIMdata(app).tracks
    p = GetPosition(track)[]
    particle = track |&gt; GetParticleDefinition
    name = particle |&gt; GetParticleName |&gt; String
    charge = particle |&gt; GetPDGCharge |&gt; Int
    energy = track |&gt; GetKineticEnergy
    push!(tracks, Track(name, charge, energy, [Point3{Float64}(x(p),y(p),z(p))]))
    return
end
#---Tracking post-action---------------------------------------------------------------------------- 
function posttrackaction(track::G4Track, app::G4JLApplication)::Nothing
    data = getSIMdata(app)
    id = track |&gt; GetTrackID
    energy = track |&gt; GetKineticEnergy
    if id == 1 &amp;&amp; energy &gt; 0.80 * data.fEkin # primary particle did not losse any energy
        if track |&gt; GetStep |&gt; GetPostStepPoint |&gt; GetPhysicalVolume == C_NULL  # Only if outside world
            data.veto = true
        end
    end
    return
end
#---Begin-event-action---------------------------------------------------------------------------- 
function beginevent(::G4Event, app::G4JLApplication)::Nothing
    data = getSIMdata(app)
    data.veto = false
    empty!(data.tracks)
    return
end
#---Begin Run Action-------------------------------------------------------------------------------
function beginrun(run::G4Run, app::G4JLApplication)::Nothing
    data = getSIMdata(app)
    gun = app.generator.data.gun
    data.fParticle = gun |&gt; GetParticleDefinition |&gt; GetParticleName |&gt; String
    data.fEkin = gun |&gt; GetParticleEnergy
    return
end</code></pre><pre><code class="nohighlight hljs">beginrun (generic function with 1 method)</code></pre><h2 id="Define-the-primary-particle-generator,-the-magnetic-filed-and-the-application"><a class="docs-heading-anchor" href="#Define-the-primary-particle-generator,-the-magnetic-filed-and-the-application">Define the primary particle generator, the magnetic filed and the application</a><a id="Define-the-primary-particle-generator,-the-magnetic-filed-and-the-application-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-primary-particle-generator,-the-magnetic-filed-and-the-application" title="Permalink"></a></h2><pre><code class="language-julia hljs">import Geant4.SystemOfUnits:tesla
#--------------------------------------------------------------------------------------------------
#---Particle Gun initialization--------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------
particlegun = G4JLGunGenerator(particle = &quot;pi+&quot;, 
                               energy = 330MeV, 
                               direction = G4ThreeVector(0,-1,0), 
                               position = G4ThreeVector(0, hbc30.worldZHalfLength,0))

#--------------------------------------------------------------------------------------------------
#---Magnetic Field initialization------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------
bfield = G4JLUniformMagField(G4ThreeVector(0,0, 1.5tesla))

#--------------------------------------------------------------------------------------------------
#---Create the Application-------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------
app = G4JLApplication(; detector = hbc30,                             # detector with parameters
                        simdata = HBC30SimData(),                     # simulation data structure
                        generator = particlegun,                      # primary particle generator
                        field = bfield,                               # uniform magnetic field
                        nthreads = 0,                                 # # of threads (0 = no MT)
                        physics_type = FTFP_BERT,                     # what physics list to instantiate
                        stepaction_method = stepaction,               # step action method
                        begineventaction_method = beginevent,         # begin-event action (initialize per-event data)
                        pretrackaction_method = pretrackaction,       # pre-tracking action
                        posttrackaction_method = posttrackaction,     # post-tracking action
                        beginrunaction_method = beginrun              # begin run action
                      );</code></pre><pre><code class="nohighlight hljs">**************************************************************
 Geant4 version Name: geant4-11-02 [MT]   (8-December-2023)
                       Copyright : Geant4 Collaboration
                      References : NIM A 506 (2003), 250-303
                                 : IEEE-TNS 53 (2006), 270-278
                                 : NIM A 835 (2016), 186-225
                             WWW : http://geant4.org/
**************************************************************</code></pre><h2 id="Draw-and-trigger-functions"><a class="docs-heading-anchor" href="#Draw-and-trigger-functions">Draw and trigger functions</a><a id="Draw-and-trigger-functions-1"></a><a class="docs-heading-anchor-permalink" href="#Draw-and-trigger-functions" title="Permalink"></a></h2><pre><code class="language-julia hljs">#---Draw functions---------------------------------------------------------------------------------
function drawdetector(s, app)
    world = GetWorldVolume()
    Geant4.draw!(s, world)
end

function drawevent(s, app)
    data = app.simdata[1]
    # clear previous plots from previous event
    tobe = [p for p in plots(s) if p isa Lines || p isa Makie.Text]  # The event is made of lines and text 
    for p in tobe
        delete!(s,p)
    end
    # draw new event
    for t in data.tracks
        style = abs(t.charge) &gt; 0. ? :solid : :dot
        lines!(s, t.points, linestyle=style)
        if t.energy &gt; data.fEkin/20
            text!(s, t.points[end], text=t.particle)
        end
    end
end

#---Very simplistic trigger to get interesting events to plot--------------------------------------
function nexttrigger(app)
    data = app.simdata[1]
    beamOn(app,1)
    n = 1
    while data.veto
        beamOn(app,1)
        n += 1
    end
    println(&quot;Got a trigger after $n generated particles&quot;)
end</code></pre><pre><code class="nohighlight hljs">nexttrigger (generic function with 1 method)</code></pre><pre><code class="language-julia hljs">#---Configure, Initialize and Run------------------------------------------------------------------                      
configure(app)
initialize(app)

ui`/tracking/storeTrajectory 2` # store auxiliary points to smooth trajectory</code></pre><pre><code class="nohighlight hljs"> G4ChordFinder: stepperDriverId: 2





0</code></pre><pre><code class="language-julia hljs">#---Draw detector and first event that triggers
fig = Figure(size=(2048,2028))
s = LScene(fig[1,1])

drawdetector(s, app)
nexttrigger(app); drawevent(s, app)

display(&quot;image/png&quot;, fig)</code></pre><pre><code class="nohighlight hljs">Got a trigger after 42 generated particles</code></pre><p><img src="../HBC30_files/HBC30_13_1.png" alt="png"/></p><pre><code class="language-julia hljs">#---Change the energy and type of particle and draw the next event
SetParticleEnergy(particlegun, 1GeV)
SetParticleByName(particlegun, &quot;e-&quot;)

fig = Figure(size=(2048,2028))
s = LScene(fig[1,1])

drawdetector(s, app)
nexttrigger(app); drawevent(s, app)

display(&quot;image/png&quot;, fig)</code></pre><pre><code class="nohighlight hljs">Got a trigger after 9 generated particles</code></pre><p><img src="../HBC30_files/HBC30_14_1.png" alt="png"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../api/">« Public API</a><a class="docs-footer-nextpage" href="../WaterPhantom/">Example WaterPhantom »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Tuesday 13 February 2024 13:18">Tuesday 13 February 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
